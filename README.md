# Шаблон проектов projects-templates-laravel1
---
## Оглавление

  - [Ссылки](#link1)
  - [Введение](#link2)
	- [Управление приложением](#link3)
  - [Заметки к релизам](#link100)

---

## Ссылки <a id="link1"></a>
```

  > Адрес образа на github
      https://github.com/4gekkman/project-devapp

			
```
## Введение <a id="link2"></a>
```

  • Это шаблон для laravel-проектов под названием "projects-templates-laravel1".
  • Данный шаблон является основным для моих laravel-проектов.
  • Подробнее про этот шаблон см.в главе ниже: "Основной шаблон для laravel-проектов".

```
## Управление приложением <a id="link3"></a>
```
--------------------------------------
Подоглавление:

  # Введение
  # API CLI-приложения
  # Файловая структура CLI-приложения
  # Конфиг CLI-приложения
  
    - Где находится конфиг
    - Способ использования конфига
    - Зачем нужен конфиг
  
  # Группы конфигов проекта
  
    - Вводная информация
    - Где хранятся наборы конфигов
    - Набор конфигов по умолчанию
    - Опция -c команды app up
    - Как происходит подстановка конфигов из выбранного набора
    
  # Основной шаблон для laravel-проектов
    
    - Про шаблоны проектов вообще
    - Про шаблон проекта laravel1
    
      ▪ Имеет специально подготовленное под laravel, настроенное окружение
      ▪ В каталоге project имеет laravel-проект
      ▪ Базы данных для предустановленных composer-пакетов laravel-проекта
    
  # Алиасы для работы с проектом
    
    - Где находятся алиасы   
    - Процесс встраивания алиасов в среду окружения текущего шелла   
    - Когда производится встраивание алиасов
    - Для чего нужны алиасы
    - В другом шелле алиасы проекта не существуют    
    
  # Запуск приложения, команда up
  
    - Что имеется в виду под запуском приложения     
    - При работе с ВМ, приложение запустится лишь в общих папках
    - Что делает CLI-команда up при запуске приложения    
   
      ▪ Копирует конфиги из configs/<группа> в configs/active
      ▪ Копирует файл configs/active/.env в project/.env    
      ▪ Копирует файл configs/active/docker-compose.yml в docker-compose.yml
      ▪ Производит простановку путей в ряде файлов
      ▪ Выполняет запуск приложения командой docker-compose up -d    

  # Обновление приложения, команда update
  
    - Что обновляет команда update   
    - Обновление приложения производится данными из репчика на GitHub
    - Что делает CLI-команда update при обновлении приложения
 
--------------------------------------

> Введение
  
  • Общая информация
    - В этой главе рассматривается управление приложением.
    - Оное осуществляется через CLI-приложение на bash.
    - Основной его функционал позволяет делать следующее:
      
      • Установить приложение.
      • Запускать приложение.
      • Останавливать приложение.
      • Обновлять приложение.
    
  • CLI-приложение каждого проекта может отличаться
    - CLI-приложение является часть шаблона проекта.
    - У каждого шаблона проекта своё, отличающееся CLI-приложение для управления.
    - В CLI-приложения уже установленного проекта также могут вноситься изменения.
    
> API CLI-приложения
  
  app           | Единая точка входа в приложение, без агрументов показывает справку.
  
  app up        | Запустить проект с помощью docker-compose
    -h          | Показать справку по команде up
    -c <name>   | Имя группы конфигов, с которыми запускать приложение (dev по умол.)
  
  app down      | Остановить проект с помощью docker-compose
    -h          | Показать справку по команде down  
  
  app update    | Обновить среду и файлы проекта с репчика на GitHub
    -h          | Показать справку по команде update
    -n          | Не запускать проект после обновления
    -c <name>   | Имя группы конфигов, с которыми запускать приложение (dev по умол.)    

  app aliases   | Создать в среде окружении шелла функции-хелперы для работы с приложением
    -h          | Показать справку по команде aliases. 
  
> Файловая структура CLI-приложения

  /<папка проекта>
    app           | Скрипт, единая точка входа в CLI-приложение
    /other
      /cli
        aliases   | Скрипт для создания в среде шелла функций-хелперов
        help      | Скрипт, содержащий справки по всему CLI-приложению
        up        | Скрипт для запуска приложения с помощью docker-compose
        down      | Скрипт для остановки приложения с помощью docker-compose
        install   | Скрипт длу установки приложения в текущий каталог
        config    | Файл с настройками проекта
    /configs
      /active       | Конфиги, с которыми запускается приложение
      /groups       | Каталог для групп конфигов
        /dev        | Каталог с группой конфигов dev
        /production | Каталог с группой конфигов production
    /data 
      /install      | Каталог с данными для копирования в /data при установке приложения
        /mysql      

> Конфиг CLI-приложения
  
  # Где находится конфиг
    - <папка проекта>/other/cli/config
    
  # Способ использования конфига
    - С помощью встроенной команды source подключается в начале файла app.
  
  # Зачем нужен конфиг
    - Содержит информацию, которая может понадобиться CLI-приложению.
    
> Группы конфигов проекта
  
  # Вводная информация
    - У каждого приложения есть набор конфигов.
    - Например, конфиги php, nginx, mysql, laravel и прочие.
    - А приложение может быть запущено в различных контекстах.
    - В контексте разработки, на продакшн-сервере, и прочих.
    - В большинстве случаев, содержимое конфигов для разных контекстов должно отличаться.
    - Поэтому, удобно иметь для каждого из контекстов свой набор конфигов.
    - И при запуске приложения указывать, какой из наборов использовать.
    - Команда up CLI-приложения позволяет это делать опцией -c.
    - По умолчанию, используется набор конфигов из каталога dev.
   
  # Где хранятся наборы конфигов
    - <папка проекта>/configs/groups
    - В configs лежат папки с наборами конфигов.
    - Имя каждого набора определяется именем его папки.
    
  # Набор конфигов по умолчанию
    - По умолчанию применяется набор конфигов dev.
    
  # Опция -c команды app up
    - При запуске приложения можно указать, какой набор конфигов исполозовать.
    - Для этого предусмотрена опция -c команды app up.
    - Опции -c надо передать имя желаемого набора конфигов.
    - Например:
    
        . app up -c production
        
  # Как происходит подстановка конфигов из выбранного набора
    - Приложение при запуске берёт конфиги из <папка проекта>/configs/active.
    - Например, выбрали набор dev (каталог: <папка проекта>/configs/groups/dev).
    - Конфиги из этого каталога копируются с заменой в каталог active.
    
> Основной шаблон для laravel-проектов

  # Про шаблоны проектов вообще
    - Шаблоны проектов я храню на GitHub.
    - Имена репчиков с шаблонами такие: projects-templates-<имя шаблона>.
    - Там могут быть шаблоны не только laravel, но и проектов на других технологиях.
    - Основным шаблоном для laravel-проектов является laravel1, вот его адрес:
    
        https://github.com/4gekkman/projects-templates-laravel1
        
    - Что из себя представляет шаблон проекта:
    
      • Некое окружение для проекта
        ▪ CLI-приложения для управления проектом
        ▪ Конфиг для docker-compose (docker-compose.yml)
        ▪ Конфиги для окружения (mysql, php, nginx, ...) и самого приложения.
        ▪ Папочка с данными
        ▪ Папочка с логами
        ▪ README.md
        ▪ .. прочее ..
        
      • Папочка project с проектом 
        - Например, там может лежать laravel-проект.
        
  # Про шаблон проекта laravel1
    
    • Имеет специально подготовленное под laravel, настроенное окружение
      ▪ NGINX
      ▪ PHP-FPM
      ▪ MySQL
      ▪ Redis
      ▪ Node.js + gulp + bower
      ▪ Websocker-сервер на node.js
      ▪ Настроенный через cron планировщик задач для laravel
      ▪ Настроенный через cron демон очередей для laravel
      ▪ .. прочее ..
    
    • В каталоге project имеет laravel-проект
      ▪ Это чистый laravel + несколько предустановленных composer-пакетов.
      ▪ По мере выхода новых патч-версий, его можно без проблем обновлять.
      ▪ По мере выхода новых минорных и мажорных версий laravel, я обновляю шаблон.
    
    • Базы данных для предустановленных composer-пакетов laravel-проекта
      - Многие из предустановленных composer-пакетов имеют базы данных.
      - Они поставляются вместе шаблоном в виде data-файлов для MySQL.
      - Именно эти данные и будут лежать в папке data свежеустановленного проекта.
      - Таким образом, после установки проекта, отдельно устанавливать базы не требуется.
   
> Алиасы для работы с проектом

  # Где находятся алиасы
    - Они находятся в файле <проект>/other/cli/aliases
    - Там находятся определения bash-функций.
    - То есть, на самом деле это не алиасы, а bash-функции.
    - Функции, а не алиасы, т.к. первым можно передавать аргументы, а это важно.
    
  # Процесс встраивания алиасов в среду окружения текущего шелла
    - Для встраивания алиасов в текущий шелл надо выполнить исполняемый файл aliases.
    - Но не просто выполнить, а с помощью команды source. Примеры:
    
        source aliases
        . aliases       // встроенная команда . (точка) является синонимом source

    - Таким образом aliases исполняется без создания нового дочернего процесса.
    - И все изменения и определения ф-ий в нём отражаются на среде окружения текущего шелла.
    - Поэтому, после выполнения aliases, все опред-ые ф-ии становятся доступны в шелле.
    
  # Когда производится встраивание алиасов
  
    ▪ При выполнении команды: app up
    ▪ При выполнении команды: app aliases
    ▪ При выполнении файла aliases не через CLI: . aliases
        
  # Для чего нужны алиасы
    - Алиасы выполняют очень важную роль, и просто необходимы для работы с проектом.
    - Здесь должен напомнить, что проект работает на основе технологий Docker.
    - Поэтому, например, нельзя просто зайти в каталог с laravel и выполнить: php artisan.
    - Ведь php у нас работает в контейнере, поэтому обращаться к artisan мы должны так:
      
        docker-compose run nginx php artisan
        
    - Аналогичная ситуация с composer, npm, bower, node, и так далее.
    - Это не слишком-то удобно, не так ли? Тут то нам и помогут алиасы.
    - Чтобы стало понятнее, вот несколько примеров таких алиасов:
    
        alias node='function f(){   docker-compose run node node "$@";  };f'
        alias npm='function f(){   docker-compose run node npm "$@";  };f'
        alias gulp='function f(){   docker-compose run node gulp "$@";  };f'
        alias bower='function f(){   docker-compose run node bower --allow-root "$@" ;  };f'
        alias php='function f(){   docker-compose run nginx php "$@";  };f'
        alias artisan='function f(){   docker-compose run nginx php artisan "$@"; };f'
        alias composer='function f(){   docker-compose run nginx composer "$@"; };f'    
   
  # В другом шелле алиасы проекта не существуют
    - Назначение алиасов проекта действуют только в текущем процессе шелла.
    - Представим, ты подключился к серверу по ssh и выполнил . app up в каталоге проекта.
    - Проект запустился, алиасы в текущем работающем процессе шелла создались.
    - Но они будут доступны лишь в этом шелле, но не в любых других шеллах.
    - Но если ты, например:
    
      ▪ Переподключишься к серверу.
      ▪ Подключишься к серверу через ещё одно ssh-подключение.
    
    - То в новых соединениях алиасов уже не будет.
    - Потому что это уже новые шелл-процессы, с новыми окружениями.
    - И в этих окружения определения функций из aliases уже отсутствуют.
    - Чтобы они там появились, можно выполнить: . app aliases. 
        
> Запуск приложения, команда up
  
  # Что имеется в виду под запуском приложения
    - Как уже упоминалось, инфраструктура (php, mysql, и т.д.) идёт в комплекте с проектом.
    - Это стало возможно благодаря технологиям контейнерезации, и Docker в нашем случае.
    - Когда ты запускаешь такое приложение, то происходит примерно следующее:
    
      • Считывается конфиг docker-compose.yml.
      • Запускаются и настраиваются описанные в нём контейнеры.
        - Совокупность этих контейнеров и представляют среду для работы приложения.
        - Контейнеры также видят сам проект, его данные.
    
    - После запуска можно взаимодействовать с проектом, например, открыть в браузере.
    
  # При работе с ВМ, приложение запустится лишь в общих папках
    - В мире виртуальных машин есть понятие общих папок.
    - Это синхронизируемые между хостом и гестом папки.
    - Эти папки можно настраивать к конфигах виртуальной машины.
    - А Docker нативно может работать только на Linux.
    - Поэтому, если вы работаете не на Linux, вам понадобится ВМ.
    - И проект будет работать нормально лишь в общих с этой ВМ папках.
    
  # Что делает CLI-команда up при запуске приложения
  
    • Копирует конфиги из configs/groups/<группа>/environment в configs/active
      - И docker-среда запустится с применением этих скопированных конфигов.
      - По умолчанию, конфиги копируются из группы dev.
      - Но с помощью опции -c можно указать другую группу конфигов.

    • Копирует файл configs/groups/<группа>/laravel/.env в project/.env
      - Это файл с настройками для laravel-проекта.
      - Из выбранной группы конфигов.
      
    • Копирует файл configs/groups/<группа>/docker-compose/docker-compose.yml в docker-compose.yml
      - Это файл с настройками для laravel-проекта.
      - Из выбранной группы конфигов.      
      
    • Производит простановку путей в ряде файлов
      - В ряде файлов шаблона проекта есть так называемые плейсхолдеры.
      - При установке проекта производится поиск и замена плейсхолдеров на актуальные данные.
      - Среди прочих, есть много плейсходлеров, обозначающих путь к каталогу проекта.
      - Соответственно, они заменяются на текущий путь к корню проекта.
      - Пути проставляются в следующих файлах:
      
        /<папка проекта>
          docker-compose.yml
          configs/active/nginx/sites/project.app
          configs/active/supervisor/supervisor.ini
          configs/active/supervisor/websocket.ini      
      
    • Выполняет запуск приложения командой docker-compose up -d
      - Эта команда, если надо, скачивает необходимые образы с Docker Hub.
      - И выполняет запуск и настройку всех описанных в docker-compose.yml контейнеров.
    
> Обновление приложения, команда update

  # Что обновляет команда update
  
    • Используемые приложением docker-образы
      - Для их обновления приложение удаляет старые образы.
      - И скачивает новые с Docker Hub.
      
    • Сами файлы приложения
      - Кроме некоторых, которые не следует обновлять (см.ниже).

  # Обновление приложения производится данными из репчика на GitHub
    
    • У каждого проекта должен быть свой репчик на GitHub
      - Команда update скачивает из этого репчика обновлённый проект.
      - И заменяет старые файлы на новые.
    
    • Адрес репчика проекта на GitHub указан в конфиге проекта
    - Сабж.
    
    • Что не обновляется при обновлении приложения
      - Всё, что не обновляется, не присутствует в репчике проекта.
      - Поскольку всё это присутствует в файле .gitignore.
      - Следующие каталоги и файлы не присутствуют в репчике:

        ▪ .git
        ▪ .idea
        ▪ docker-compose.yml
        ▪ supervisord.*
        ▪ other/logs
        ▪ data
        ▪ configs/active
    
  # Что делает CLI-команда update при обновлении приложения
    
    • Считывает URL репчика проекта из конфига, проверяет его наличие
    
    • Останавливает приложение с помощью docker-compose down
    
    • Удаляет все связанные с приложением docker-образы, скачивает новые
    
    • Скачивает содержимое репчика, заменяет им текущее содержимое проекта
    
    • Запускает проект с помощью команды . app up
      - Но только если не передана опция -n.
      - И если передана команда -c, передав команде up её тоже.  
      
```
## Заметки к релизам <a id="link100"></a>
```

  1.0.0
    - Первый релиз.

```